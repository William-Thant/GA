<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
    
        .navbar-custom {
            background-color: #9e9e9e;
        }

        .navbar-custom .nav-link,
        .navbar-custom .navbar-brand,
        .navbar-custom .navbar-text {
            color: #1f1f1f;
            font-weight: 600;
        }

        .navbar-custom .nav-link:hover,
        .navbar-custom .navbar-brand:hover {
            color: #111111;
        }

        .logo-img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        .nav-search {
            min-width: 200px;
            border-radius: 999px;
        }

        .nav-btn {
            border-radius: 999px;
        }

        .account-pill {
            background: #424242;
            color: #ffffff;
            padding: 0.4rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
        }
            
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }

        .product-box {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .product-box:hover {
            transform: translateY(-5px);
        }

        .product-box img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .product-box:hover img {
            transform: scale(1.05);
        }

        .product-name {
            padding: 1rem;
            background: white;
        }

        .product-name h4 {
            margin: 0;
            color: var(--text-color);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .product-actions {
            display: flex;
            justify-content: flex-end;
            padding: 0 1rem 1rem;
        }

        .delete-btn {
            border-radius: 999px;
        }

        .page-header {
            text-align: center;
            padding: 2rem 0;
            color: var(--primary-color);
        }

        .stats-container {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .account-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
            }
        }

        .loading-indicator {
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
    <link rel="stylesheet" href="/style.css">
    <title>Ecomme</title>
</head>
<body class="page-shell">
    <%- include('partials/topbar') %>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-custom navbar-light">
        <div class="container-fluid">
            <span class="navbar-brand d-flex align-items-center gap-2">&nbsp;</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="collapsibleNavbar">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link <%= (currentBase === '/home' || currentPath === '/') ? 'active-nav' : '' %>" href="/home">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= currentBase === '/products' ? 'active-nav' : '' %>" href="/products">Products</a>
                    </li>
                    <% if (user && user.role === 'admin') { %>
                    <li class="nav-item">
                        <a class="nav-link <%= currentBase === '/addProduct' ? 'active-nav' : '' %>" href="/addProduct">Add Product</a>
                    </li>
                    <% } %>
                    <%- include("partials/admin-nav") %>
                    <li class="nav-item">
                        <a class="nav-link <%= currentBase === '/wallet' ? 'active-nav' : '' %>" href="/wallet">Wallet</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link <%= currentBase === '/about' ? 'active-nav' : '' %>" href="/about">About Us</a>
                    </li>
                </ul>
                <div class="d-flex me-lg-3 my-2 my-lg-0">
                    <input class="form-control nav-search" type="search" placeholder="Search products" aria-label="Search">
                </div>
                <div class="d-flex align-items-center gap-2">
                    <% if (showCartNav && !(user && user.role === 'admin')) { %>
                    <a class="btn btn-dark nav-btn" href="/cart">Add to Cart</a>
                    <% } %>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <% if (!hideHero) { %>
        
        <div class="hero mb-4">
            <div class="d-flex flex-wrap gap-4 align-items-center">
                <div class="flex-grow-1">
                    <div class="pill mb-3">Escrow-secured marketplace</div>
                    <h1 class="mb-2">Welcome to Ecomme<% if (user && user.name) { %>, <%= user.name %><% } %></h1>
                    <p class="lead mb-3">Shop and sell with confidence: every purchase is protected by on-chain escrow and clear delivery tracking.</p>
                    <div class="hero-cta">
                        <a class="btn btn-dark" href="#productGallery">Browse products</a>
                        <a class="btn btn-outline-dark" href="/wallet">Wallet & rewards</a>
                    </div>
                    <div class="hero-badges">
                        <span class="hero-badge">Instant checkout</span>
                        <span class="hero-badge">Transparent tracking</span>
                        <span class="hero-badge">Secure payments</span>
                    </div>
                </div>
                <div class="glass-card text-center">
                    <div class="section-heading mb-2"><span>Store Snapshot</span></div>
                    <div class="d-flex flex-column gap-2">
                        <div>
                            <div class="text-muted">Available Products</div>
                            <div class="display-6 fw-bold"><%= cnt %></div>
                        </div>
                        <div class="border-top pt-2">
                            <div class="text-muted">Current Account</div>
                            <div class="fw-semibold"><%= acct %></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="section-heading mb-0"><span>Product Gallery</span></div>
            <% if (user && user.role === 'admin') { %>
            <a href="/addProduct" class="btn btn-outline-dark">Add product</a>
            <% } %>
        </div>
        
        <div class="grid-container" id="productGallery">
            <% for(let i=0; i < products.length; i++) { %>
                <% const p = products[i]; %>
                <% const isJson = !!p.productId; %>
                <% const catalog = p.catalog ? p.catalog : p; %>

                <% const displayName = catalog.name ? catalog.name : (p.productInfo?.name || "Unnamed"); %>
                <% const imgFile = catalog.image ? catalog.image : null; %>
                <% const cardImage = imgFile ? ("/images/" + imgFile) : "/images/ecomme.png"; %>
                <% const linkId = isJson ? p.productId : p.id; %>

                <div class="product-box">   
                        <a href="/product/<%= p.productId %>" class="text-decoration-none">
                        <img src="<%= cardImage %>" alt="<%= displayName %>">
                        <div class="product-name">
                            <h4><%= displayName %></h4>
                            <p class="mb-2 text-muted small"><%= catalog && catalog.description ? catalog.description : 'Product details coming soon.' %></p>
                            <div class="product-meta">
                                <span class="price-tag">$<%= catalog && catalog.price !== undefined ? catalog.price : '0.00' %></span>
                                <span class="stock-chip">Stock: <%= catalog && catalog.stock !== undefined ? catalog.stock : 0 %></span>
                            </div>
                        </div>
                    </a>
                    <% if (catalog) { %>
                        <div class="product-actions">
                            <% if (!(user && user.role === 'admin')) { %>
                            <form action="/addToCart/<%= p.productId %>" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-success">Add to Cart</button>
                            </form>
                            <% } %>
                            <% if (user && user.role === 'admin') { %>
                            <a href="/editProduct/<%= p.productId %>" class="btn btn-sm btn-outline-primary me-2">Edit</a>
                            <form action="/deleteProduct/<%= linkId %>" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
                            </form>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            <% } %>
        </div>
        <% } %>
    </div>

    <script>
        window.onload = function() {
            // Get the current refresh count from sessionStorage
            let refreshCount = sessionStorage.getItem("refreshCount");
            console.log(refreshCount)
            // If this is the first load, initialize the counter to 0
            if (refreshCount === null) {
                refreshCount = 0;
            } else {
                // Convert to a number and increment
                refreshCount = parseInt(refreshCount) + 1;
            }

            // Save the updated counter back to sessionStorage
            sessionStorage.setItem("refreshCount", refreshCount);

            // Reload the page if the counter is less than 3
            if (refreshCount < 3) {
                console.log(refreshCount);
                //window.location.reload();
                setTimeout(function() {
                    window.location.reload();
                }, 6000); // 2000 milliseconds = 2 seconds
            }
        };
    </script>
</body>
</html>


