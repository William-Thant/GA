<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Delivery Tracking - Ecommerce</title>
  <style>
    body { background-color: #f8f9fa; }
    .tracking-container {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .timeline { position: relative; padding-left: 30px; }
    .timeline::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #dee2e6;
    }
    .timeline-item { position: relative; margin-bottom: 1rem; }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -22px;
      top: 5px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #28a745;
    }
    .confirm-btn {
      background-color: #28a745;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 5px;
      color: #fff;
    }
    .confirm-btn:hover { background-color: #218838; }
  </style>
</head>

<body>
  <div class="container">
    <div class="tracking-container">
      <h1 class="mb-4">Delivery Tracking</h1>

      <% if (escrowData && !escrowData.error) { %>
        <div class="row mb-4">
          <div class="col-md-6">
            <h5>Tracking ID: <%= deliveryStatus?.trackingId || "-" %></h5>
            <p><strong>Order ID:</strong> <%= escrowData.orderId %></p>
            <p><strong>Carrier:</strong> <%= deliveryStatus?.carrier || "-" %></p>
            <p><strong>Last Updated:</strong>
              <%= deliveryStatus?.lastUpdated ? new Date(deliveryStatus.lastUpdated).toLocaleString() : "-" %>
            </p>
          </div>

          <div class="col-md-6">
            <p><strong>Payment Status:</strong> Secured on Blockchain</p>
            <p><strong>Escrow Status:</strong>
              <%= escrowData.status == 0 ? 'None'
                : escrowData.status == 1 ? 'Funds Locked'
                : escrowData.status == 2 ? 'Released'
                : 'Refunded' %>
            </p>
          </div>
        </div>

        <h5>Delivery Timeline</h5>
        <div class="timeline">
          <% (deliveryStatus?.timeline || []).forEach(item => { %>
            <div class="timeline-item">
              <strong><%= item.status %></strong> - <%= new Date(item.date).toLocaleString() %>
            </div>
          <% }); %>
        </div>

        <% if (escrowData.status == 1) { %>
          <!-- FundsLocked = 1, so buyer can confirm delivery now -->
          <form action="/escrow/confirm" method="POST" class="mt-4">
            <input type="hidden" name="orderId" value="<%= escrowData.orderId %>">
            <button type="submit" class="confirm-btn">Confirm Delivery & Release Funds</button>
          </form>
          <p class="text-muted mt-2">
            Confirming delivery will release funds to the seller. (Token awarding depends on your loyalty feature route.)
          </p>
        <% } else if (escrowData.status == 2) { %>
          <p class="text-success mt-4">Delivery confirmed! Funds have been released to the seller.</p>
        <% } else if (escrowData.status == 3) { %>
          <p class="text-danger mt-4">This order was refunded.</p>
        <% } %>

        <div class="mt-4">
          <a href="/orderDetails?orderId=<%= encodeURIComponent(escrowData.orderId) %>" class="btn btn-outline-secondary">
            Back to Order Details
          </a>
        </div>

      <% } else { %>
        <p>Error loading tracking information.</p>
        <% if (escrowData && escrowData.error) { %>
          <p><%= escrowData.error %></p>
        <% } %>
        <a href="/" class="btn btn-outline-secondary mt-3">Back Home</a>
      <% } %>
    </div>
  </div>
</body>
</html>