<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Checkout - Ecommerce</title>
  <style>
    body { background-color: #f8f9fa; }
    .checkout-container {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .order-summary { background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
    .escrow-info { background: #e9ecef; padding: 1rem; border-radius: 5px; margin-bottom: 1rem; }
    .lock-btn {
      background-color: #dc3545;
      border: none;
      padding: 0.75rem 2rem;
      font-size: 1.2rem;
      border-radius: 5px;
      width: 100%;
      color: #fff;
    }
    .lock-btn:hover { background-color: #c82333; }
    .lock-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    code { background: #f1f3f5; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="checkout-container">
      <h1 class="mb-4">Checkout</h1>

      <div class="order-summary">
        <h4>Order Summary</h4>
        <p><strong>Order ID:</strong> <%= orderId %></p>
        <ul>
          <% cartItems.forEach(item => { %>
            <li>
              <%= item.name %> (x<%= item.quantity %>) - $<%= (item.price * item.quantity).toFixed(2) %>
            </li>
          <% }); %>
        </ul>
        <p><strong>Subtotal:</strong> $<%= subtotal.toFixed(2) %></p>
        <p><strong>Shipping Fee:</strong> $<%= shippingFee.toFixed(2) %></p>
        <p><strong>Total:</strong> $<%= total.toFixed(2) %></p>
      </div>

      <div class="mb-3">
        <label for="deliveryAddress" class="form-label">Delivery Address</label>
        <textarea class="form-control" id="deliveryAddress" rows="3" required></textarea>
      </div>

      <div class="escrow-info"
        data-escrow
        data-escrow-address="<%= contractAddress %>"
        data-seller-address="<%= sellerAcct %>"
        data-order-id="<%= orderId %>"
        data-eth-amount="<%= (total / 2000).toFixed(4) %>"
        data-order-endpoint="/orders"
        data-order-items='<%- JSON.stringify(cartItems) %>'>

        <h5>Escrow Payment</h5>
        <p>Status: <span data-escrow-status>Pending</span></p>

        <p><strong>Contract:</strong> <code><%= contractAddress %></code></p>
        <p><strong>Seller:</strong> <code><%= sellerAcct %></code></p>
        <p><strong>Amount (ETH):</strong> <%= (total / 2000).toFixed(4) %></p>

        <div class="alert alert-secondary py-2">
          <div><strong>Wallet:</strong> <span data-wallet-status>Not connected</span></div>
          <div><strong>Address:</strong> <span data-wallet-address>-</span></div>
          <button type="button" class="btn btn-sm btn-outline-dark mt-2" data-connect-wallet>Connect MetaMask</button>
        </div>

        <button type="button" class="lock-btn" data-escrow-submit>
          Lock Funds in Escrow
        </button>

        <div class="small text-muted mt-2">
          Redirects to: <code>/orderDetails?orderId=<%= orderId %></code>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <script src="/js/escrow-frontend.js"></script>
</body>
</html>
